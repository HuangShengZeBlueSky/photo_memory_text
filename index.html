<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DANG PHUONG CHINH - Eternal Moments</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Great+Vibes&family=Lato:wght@300;400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://gosspublic.alicdn.com/aliyun-oss-sdk-6.17.1.min.js"></script>

    <style>
        :root {
            --primary-pink: #ffc2d1;
            --deep-rose: #c75b7a;
            --gold: #d4af37;
            --glass-bg: rgba(255, 255, 255, 0.85);
            --glass-border: 1px solid rgba(255, 255, 255, 0.9);
            --shadow: 0 8px 32px 0 rgba(168, 114, 131, 0.2);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Lato', sans-serif;
            background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);
            background-image: linear-gradient(120deg, #fff0f3 0%, #fff5f6 100%);
            min-height: 100vh;
            color: #5d4037;
            overflow-x: hidden;
        }

        /* --- æ¨±èŠ±ç‰¹æ•ˆ --- */
        #sakura-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 0;
        }
        .sakura {
            position: absolute; background-color: #ffd1dc;
            border-radius: 100% 0 100% 0; opacity: 0.6;
            animation: fall linear infinite;
        }
        @keyframes fall { to { transform: translateY(100vh) rotate(720deg); } }

        /* --- å¤´éƒ¨ --- */
        header {
            text-align: center; padding: 60px 20px 40px; position: relative; z-index: 10;
        }
        h1 {
            font-family: 'Cinzel', serif; font-size: 3.5rem;
            background: linear-gradient(to right, #bf953f, #aa771c);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            text-shadow: 0px 4px 10px rgba(212, 175, 55, 0.3);
            margin-bottom: 10px;
        }
        .subtitle { font-family: 'Great Vibes', cursive; font-size: 2rem; color: var(--deep-rose); }

        /* --- ä¸»å¸ƒå±€ (Grid) --- */
        .main-layout {
            display: grid;
            grid-template-columns: 2.5fr 1fr; /* å·¦ä¾§ç…§ç‰‡å®½ï¼Œå³ä¾§ç•™è¨€çª„ */
            gap: 30px;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 10;
        }

        /* --- å·¦ä¾§ï¼šä¸Šä¼ ä¸ç”»å»Š --- */
        .upload-section {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            border: var(--glass-border);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
            display: flex; gap: 15px; align-items: center;
        }
        .input-glass {
            flex: 1; padding: 12px 20px; border-radius: 25px; border: 2px solid #fff;
            background: rgba(255,255,255,0.6); outline: none; transition: 0.3s;
        }
        .input-glass:focus { border-color: var(--primary-pink); background: #fff; }

        .btn-gold {
            background: linear-gradient(45deg, #d4af37, #e6c55d);
            color: white; border: none; padding: 10px 25px;
            border-radius: 25px; cursor: pointer; font-weight: bold;
            box-shadow: 0 4px 10px rgba(212, 175, 55, 0.3);
            transition: 0.3s; display: flex; align-items: center; gap: 8px; white-space: nowrap;
        }
        .btn-gold:hover { transform: translateY(-2px); }
        .btn-gold:disabled { background: #ccc; cursor: not-allowed; transform: none; }

        /* ç€‘å¸ƒæµ */
        .gallery-grid {
            columns: 2; column-gap: 20px;
        }
        .photo-card {
            break-inside: avoid; margin-bottom: 20px;
            background: #fff; border-radius: 15px; overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            transition: 0.3s; position: relative;
            border: 1px solid rgba(212, 175, 55, 0.1);
        }
        .photo-card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(199, 91, 122, 0.15); }
        .photo-card img { width: 100%; display: block; }
        .card-content { padding: 15px; }
        .card-desc { font-family: 'Cinzel', serif; color: #444; margin-bottom: 10px; font-size: 0.95rem; }
        
        .action-bar {
            display: flex; justify-content: space-between; align-items: center;
            border-top: 1px solid #eee; padding-top: 10px;
            color: #888; font-size: 0.85rem;
        }
        .like-btn { cursor: pointer; transition: 0.3s; }
        .like-btn:hover, .like-btn.active { color: #ff4757; transform: scale(1.2); }

        /* --- å³ä¾§ï¼šç•™è¨€æ¿ --- */
        .sidebar { position: sticky; top: 20px; height: fit-content; }
        .message-box {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            border: var(--glass-border);
            border-radius: 20px;
            padding: 20px;
            box-shadow: var(--shadow);
            height: 80vh; /* å›ºå®šé«˜åº¦ */
            display: flex; flex-direction: column;
        }
        .box-title {
            text-align: center; font-family: 'Cinzel', serif; color: var(--deep-rose);
            margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid var(--primary-pink);
        }
        .msg-list {
            flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; padding-right: 5px;
        }
        .msg-item {
            background: rgba(255,255,255,0.9); padding: 12px; border-radius: 10px;
            border-left: 3px solid var(--gold); font-size: 0.9rem;
            animation: fadeIn 0.5s;
        }
        .msg-footer {
            display: flex; justify-content: space-between; margin-top: 5px; font-size: 0.75rem; color: #999;
        }
        .input-area { margin-top: 15px; display: flex; gap: 10px; }

        /* å“åº”å¼ */
        @media (max-width: 900px) {
            .main-layout { grid-template-columns: 1fr; }
            .sidebar { position: static; height: auto; }
            .message-box { height: 500px; }
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Loadingé®ç½© */
        #global-loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.8); z-index: 2000;
            display: flex; justify-content: center; align-items: center;
            font-family: 'Cinzel', serif; color: var(--deep-rose); font-size: 1.5rem;
            display: none; /* é»˜è®¤éšè— */
        }
    </style>
</head>
<body>

    <div id="global-loader"><i class="fas fa-spinner fa-spin"></i> &nbsp; Syncing with Cloud...</div>
    <div id="sakura-container"></div>

    <header>
        <h1>DANG PHUONG CHINH</h1>
        <div class="subtitle">Cloud Gallery & Whispers</div>
    </header>

    <div class="main-layout">
        
        <section>
            <div class="upload-section">
                <input type="file" id="fileInput" accept="image/*" style="display:none">
                <button class="btn-gold" onclick="document.getElementById('fileInput').click()">
                    <i class="fas fa-camera"></i>
                </button>
                <input type="text" id="descInput" class="input-glass" placeholder="åˆ†äº«æ­¤åˆ»çš„ç”»é¢ä¸å¿ƒæƒ…...">
                <button class="btn-gold" onclick="handleUpload()">å‘å¸ƒ (Post)</button>
            </div>

            <div class="gallery-grid" id="gallery-container">
                </div>
        </section>

        <aside class="sidebar">
            <div class="message-box">
                <h3 class="box-title">Message Board</h3>
                <div class="msg-list" id="msg-list-container">
                    <div style="text-align:center; color:#999; margin-top:20px;">Loading messages...</div>
                </div>
                <div class="input-area">
                    <input type="text" id="msgInput" class="input-glass" placeholder="ç•™ä¸‹ä½ çš„ç¥ç¦...">
                    <button class="btn-gold" onclick="handleSendMessage()"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </aside>
    </div>

    <script>
        // ==========================================
        // ğŸ”´ å¿…é¡»é…ç½®: å¡«å…¥ä½ çš„é˜¿é‡Œäº‘ä¿¡æ¯ ğŸ”´
        // ==========================================
        const ossConfig = {
            region: 'oss-cn-beijing',         // æ ¹æ®ä½ æˆªå›¾ç¡®è®¤æ˜¯åŒ—äº¬
            accessKeyId: '=',
            accessKeySecret: '=',
            bucket: 'dangphuongchinh'         // æ ¹æ®ä½ æˆªå›¾ç¡®è®¤
        };
        const DB_FILE_NAME = 'site_data_v2.json'; // æˆ‘ä»¬ç”¨è¿™ä¸ªæ–‡ä»¶å½“æ•°æ®åº“
        // ==========================================

        let client = null;
        let siteData = { messages: [], likes: {} }; // æœ¬åœ°æ•°æ®ç¼“å­˜

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            startSakura();
            try {
                client = new OSS(ossConfig);
                await loadAllData(); // åŠ è½½æ‰€æœ‰æ•°æ®
            } catch (e) {
                console.error("åˆå§‹åŒ–å¤±è´¥:", e);
                alert("è¯·æ£€æŸ¥ä»£ç é‡Œçš„ Key æ˜¯å¦å¡«å¯¹ï¼");
            }
        });

        // --- æ ¸å¿ƒé€»è¾‘ï¼šæ•°æ®åŒæ­¥ ---

        // 1. åŠ è½½æ•°æ® (å›¾ç‰‡ + JSONæ•°æ®åº“)
        async function loadAllData() {
            showLoading(true);
            try {
                // A. è·å– 'æ•°æ®åº“' JSON
                try {
                    const result = await client.get(DB_FILE_NAME);
                    // è§£æ JSON æ–‡ä»¶å†…å®¹
                    const content = new TextDecoder("utf-8").decode(result.content);
                    siteData = JSON.parse(content);
                } catch (err) {
                    console.log("æ•°æ®åº“æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆå§‹åŒ–æ–°æ•°æ®åº“...");
                    siteData = { messages: [], likes: {} };
                }

                // B. è·å–å›¾ç‰‡åˆ—è¡¨
                const listResult = await client.list({ prefix: 'memories/', 'max-keys': 100 });
                const objects = listResult.objects || [];
                
                // æŒ‰æ—¶é—´å€’åº
                objects.sort((a, b) => new Date(b.lastModified) - new Date(a.lastModified));

                // C. æ¸²æŸ“é¡µé¢
                renderGallery(objects);
                renderMessages();

            } catch (err) {
                console.error("åŠ è½½æ•°æ®å‡ºé”™:", err);
            }
            showLoading(false);
        }

        // 2. ä¿å­˜æ•°æ®åˆ°äº‘ç«¯ (æ›´æ–° JSON)
        async function saveDatabase() {
            // å°†å¯¹è±¡è½¬å› JSON å­—ç¬¦ä¸²å¹¶ä¸Šä¼ è¦†ç›–åŸæ–‡ä»¶
            const jsonString = JSON.stringify(siteData);
            const blob = new Blob([jsonString], { type: 'application/json' });
            await client.put(DB_FILE_NAME, blob);
        }

        // --- åŠŸèƒ½é€»è¾‘ ---

        // ä¸Šä¼ å›¾ç‰‡
        async function handleUpload() {
            const fileInput = document.getElementById('fileInput');
            const descInput = document.getElementById('descInput');
            
            if(fileInput.files.length === 0) return alert("è¯·å…ˆé€‰å›¾");
            
            showLoading(true);
            const file = fileInput.files[0];
            const filename = 'memories/' + Date.now() + '_' + file.name;
            
            // æŠŠæè¿°å­˜å…¥ Metadata
            const desc = descInput.value || "Moment";
            const encodedDesc = btoa(encodeURIComponent(desc));

            try {
                await client.put(filename, file, { meta: { description: encodedDesc } });
                fileInput.value = ''; descInput.value = '';
                await loadAllData(); // é‡æ–°åŠ è½½ä»¥æ˜¾ç¤ºæ–°å›¾
            } catch (e) {
                alert("ä¸Šä¼ å¤±è´¥"); console.error(e);
            }
            showLoading(false);
        }

        // å‘é€ç•™è¨€
        async function handleSendMessage() {
            const input = document.getElementById('msgInput');
            if(!input.value) return;

            const newMsg = {
                id: Date.now(),
                text: input.value,
                likes: 0
            };

            siteData.messages.unshift(newMsg); // åŠ åˆ°æœ€å‰é¢
            renderMessages(); // ä¹è§‚æ›´æ–° (å…ˆæ˜¾ç¤ºï¼Œå†ä¿å­˜)
            input.value = '';

            try {
                await saveDatabase();
            } catch(e) { console.error("ç•™è¨€ä¿å­˜å¤±è´¥", e); }
        }

        // ç‚¹èµåŠŸèƒ½ (å›¾ç‰‡æˆ–ç•™è¨€)
        async function handleLike(type, id, btnElement) {
            if (btnElement.classList.contains('active')) return; // é˜²æ­¢é‡å¤ç‚¹èµ
            
            btnElement.classList.add('active');
            const countSpan = btnElement.querySelector('span');
            let count = parseInt(countSpan.innerText) || 0;
            countSpan.innerText = count + 1;

            // æ›´æ–°æ•°æ®
            if (type === 'image') {
                // å›¾ç‰‡ç‚¹èµ key æ˜¯æ–‡ä»¶åï¼Œvalue æ˜¯æ•°é‡
                if (!siteData.likes[id]) siteData.likes[id] = 0;
                siteData.likes[id]++;
            } else if (type === 'message') {
                const msg = siteData.messages.find(m => m.id === id);
                if (msg) msg.likes = (msg.likes || 0) + 1;
            }

            // é™é»˜ä¿å­˜ (ä¸é˜»ç¢ç”¨æˆ·æ“ä½œ)
            try { await saveDatabase(); } catch(e){ console.log("ç‚¹èµåŒæ­¥å¤±è´¥"); }
        }

        // --- æ¸²æŸ“é€»è¾‘ ---

        function renderGallery(objects) {
            const container = document.getElementById('gallery-container');
            container.innerHTML = '';

            objects.forEach(obj => {
                const url = client.signatureUrl(obj.name); // è·å–å›¾ç‰‡é“¾æ¥
                let desc = "Moment";
                // å°è¯•ä»æ–‡ä»¶åè·å–æè¿° (ç®€å•å¤„ç†ï¼Œå› ä¸ºListä¸ç›´æ¥è¿”Meta)
                // çœŸæ­£ç”Ÿäº§ç¯å¢ƒå»ºè®®æŠŠæè¿°ä¹Ÿå­˜åœ¨ data.json é‡Œï¼Œè¿™é‡Œä¸ºäº†ç®€åŒ–æ²¿ç”¨ Meta é€»è¾‘ä½† List è¯»ä¸åˆ° Meta
                // æˆ‘ä»¬åšä¸€ä¸ªç®€å•ä¼˜åŒ–ï¼šå¦‚æœ data.json é‡Œæ²¡å­˜è¿™ä¸ªå›¾çš„æè¿°ï¼Œå°±æ˜¾ç¤ºé»˜è®¤ã€‚
                
                const likeCount = siteData.likes[obj.name] || 0;

                const card = document.createElement('div');
                card.className = 'photo-card';
                card.innerHTML = `
                    <img src="${url}" loading="lazy">
                    <div class="card-content">
                        <div class="action-bar">
                            <div class="like-btn" onclick="handleLike('image', '${obj.name}', this)">
                                <i class="fas fa-heart"></i> <span>${likeCount}</span>
                            </div>
                            <div style="font-size:0.8em">${new Date(obj.lastModified).toLocaleDateString()}</div>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function renderMessages() {
            const container = document.getElementById('msg-list-container');
            container.innerHTML = '';
            siteData.messages.forEach(msg => {
                const div = document.createElement('div');
                div.className = 'msg-item';
                div.innerHTML = `
                    <div>${msg.text}</div>
                    <div class="msg-footer">
                        <span>${new Date(msg.id).toLocaleTimeString()}</span>
                        <span class="like-btn" onclick="handleLike('message', ${msg.id}, this)">
                            <i class="fas fa-heart"></i> <span>${msg.likes || 0}</span>
                        </span>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function showLoading(show) {
            document.getElementById('global-loader').style.display = show ? 'flex' : 'none';
        }

        // æ¨±èŠ±
        function startSakura() {
            const c = document.getElementById('sakura-container');
            setInterval(() => {
                const s = document.createElement('div');
                s.classList.add('sakura');
                s.style.left = Math.random()*100+'vw';
                s.style.width = Math.random()*10+5+'px'; s.style.height = s.style.width;
                s.style.animationDuration = Math.random()*3+2+'s';
                c.appendChild(s);
                setTimeout(()=>s.remove(), 5000);
            }, 300);
        }
    </script>
</body>
</html>